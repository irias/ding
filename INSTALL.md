# Installing

You'll need an empty postgres database, and a config.json file like:

	{
		"showSherpaErrors": true,
		"printSherpaErrorStack": true,
		"database": "dbname=ding host=localhost user=ding password=secretpassword sslmode=disable",
		"environment": {
			"GEM_PATH": "/home/ding/.gem/ruby/2.3.0",
			"PATH": "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/ding/node_modules/.bin/:/home/ding/.gem/ruby/2.3.0/bin:/home/ding/toolchains/bin",
			"TOOLCHAINS": "/home/ding/toolchains"
		},
		"notify": {
			"name": "devops",
			"email": "devops@example.org"
		},
		"baseURL": "https://ding.example.org",
		"githubWebhookSecret": "very secret",
		"bitbucketWebhookSecret": "very secret but different",
		"run": ["nice", "timeout", "600"],
		"isolateBuilds": {
			"enabled": false,
			"dingUid": 1001,
			"dingGid": 1001,
			"uidStart": 10000,
			"uidEnd": 20000,
			"chownBuild": [
				"sudo", "/home/ding/ding", "chownbuild", "/home/ding/config.json"
			],
			"runas": [
				"/home/ding/runas"
			],
			"buildsDir": "/home/ding/data/build"
		},
		"mail": {
			"enabled": false,
			"from": "info@example.org",
			"fromName": "Ding",
			"replyto": "",
			"replytoName": "",
			"smtpHost": "localhost",
			"smtpTls": true,
			"smtpPort": 587,
			"smtpUsername": "username",
			"smtpPassword": "secretpassword"
		}
	}

Then give the database initialization a try.
You'll use this for upgrades in future versions as well:

	ding upgrade config.json

And now with commit if the previous was successful:

	ding upgrade config.json commit


# Dependencies

Make sure you have git installed if you plan to build git repositories.
Or mercurial (hg), or any other VCS you want to use.


# Notifications

You probably want to enable email notifications for failed builds.
Configure a mail server, and set "mail", "enabled" to true.

We don't support other mechanisms to send notifications (like
outgoing webhooks, or IRC/telegram/slack/etc). Instead we have a
real-time streaming updates API that can be used for those purposes.


# Isolate builds

You should also isolate builds by running each build under a unique user id.
You'll need some more configuration.
First, configure sudo to run the "ding chownbuild" command that is
already specified in the config file:

	# template: executing-user (hosts) = (user-to-run-as) dont-ask-for-password path-with-parameters
	ding ALL = (ALL) NOPASSWD:/home/ding/ding chownbuild /home/ding/config.json *

Second, create a command /home/ding/runas. It will be called as
"runas uid gid command param ...". It must run the command with
params under the specified uid/gid. "uidStart" and "uidEnd"
in the config file specify a range of uids that will be used.
Unfortunately, sudo isn't usable in this case, you cannot specify
uid ranges. Instead, use the runas.c file from the ding repository:

	cd /home/ding
	cc -Wall -o runas.c runas
	chown root:ding runas
	chmod 4750 runas
	cat 10000 >/etc/runas.conf
	chown root:ding /etc/runas.conf
	chmod 640 /etc/runas.conf

Set "uid" and "gid" to the uid/gid ding is running under.
Finally, set "isolateBuilds" to true.

It is important to run ding with umask 027 in this case. The group
read permissions ensure ding can still read the files generated by
the build. "Other"s on the system shouldn't have access to the build
directories, they will probably contain credentials. It's recommended
to make files containing credentials in the build directory unreadable
by anything other than the owner.


# Github and bitbucket webhooks for push events

Ding supports starting builds on pushes to github or bitbucket
repositories.  Start ding with the -listenwebhooks flag and set
"githubWebhookSecret" and/or "bitbucketWebhookSecret" in the config
file.

You'll need to configure a "webhook" for your repositories.

For github:

- Make a URL that points to your server, with path /github/<repoName>.
- Select "application/json" as event type - send only "push" events
(default at the time of writing) - set the same secret as in the
config file.

For bitbucket:

- Make a URL that points to your server, with path
/bitbucket/<repoName>/<bitbucketWebhookSecret>. Bitbucket does not
sign its requests, so the authentication is in the URL.

If you don't want to listen for webhook events, pass an empty string
to the -listenwebhook flag.


# Webserver configuration

You might want to run a HTTP proxy in front of Ding. Nginx is a
popular choice. Here is an example config file that keeps server-sent
events working:

	server {
		listen 10.0.0.1:80;
		server_name ding-internal.example.com;

		location / {
			include /etc/nginx/proxy_params;
			proxy_pass http://127.0.0.1:6084;
		}
		location = /events {
			include /etc/nginx/proxy_params;
			proxy_pass http://127.0.0.1:6084;
			proxy_buffering off;
			proxy_cache off;
			proxy_set_header Connection '';
			proxy_http_version 1.1;
			chunked_transfer_encoding off;
			proxy_read_timeout 1w;
		}
	}


# Monitoring

Ding exposes Prometheus metrics at HTTP endpoint /metrics.
This includes statistics on usage for the API.

You can also set up simple HTTP monitoring on /ding/status. It's
the "status" API call and it will a 5xx status when one of its
underlying services (file system, database) is not available.


# Service file

Example service file for systemd:

	[Unit]
	Description=ding
	After=network.target

	[Service]
	UMask=0027
	Restart=always
	RestartSec=1s
	LimitNOFILE=16384
	SyslogIdentifier=ding
	SyslogFacility=local0
	User=ding
	Group=ding
	WorkingDirectory=/home/irias/projects/ding
	ExecStart=/home/irias/projects/ding/ding serve -listen 127.0.0.1:6084 -listenwebhook 127.0.0.1:6085 config.json

	[Install]
	WantedBy=multi-user.target

This listens only on the loopback IP. Note we don't keep the binary
and config in the (mostly empty) ding home directory.
